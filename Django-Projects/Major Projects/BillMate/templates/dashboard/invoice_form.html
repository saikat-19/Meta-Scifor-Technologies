{% extends 'dashboard/base_dashboard.html' %}
{% load static %}

{% block extra_head %}
<!-- Tailwind CSS CDN -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Bootstrap CSS CDN -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Font Awesome Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Custom External CSS -->
<style>
    /* Dashboard consistent styling */
    .form-section {
        background: white;
        border-radius: 0.75rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        border: 1px solid #f3f4f6;
        margin-bottom: 1.5rem;
        padding: 1.5rem;
    }
    
    .section-header {
        border-bottom: 1px solid #f3f4f6;
        padding-bottom: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .section-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: #374151;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .form-group {
        margin-bottom: 1rem;
    }
    
    .form-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: #374151;
        margin-bottom: 0.25rem;
    }
    
    .form-control {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    
    .form-control:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .form-select {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
    }
    
    .form-select:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .item-row {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 0.75rem;
        display: grid;
        grid-template-columns: 2fr 120px 120px 120px 50px;
        gap: 1rem;
        align-items: start;
        transition: all 0.2s ease;
    }
    
    .item-row:hover {
        border-color: #d1d5db;
    }
    
    .item-description {
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        width: 100%;
    }
    
    .item-description:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .item-total {
        background: #ecfdf5;
        border: 1px solid #d1fae5;
        border-radius: 0.5rem;
        padding: 0.5rem;
        text-align: center;
        font-weight: 600;
        color: #065f46;
    }
    
    .btn-primary {
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 0.5rem;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .btn-primary:hover {
        background: #2563eb;
    }
    
    .btn-secondary {
        background: white;
        color: #374151;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .btn-secondary:hover {
        background: #f9fafb;
        border-color: #9ca3af;
    }
    
    .btn-danger {
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 50%;
        width: 1.5rem;
        height: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.2s ease;
        font-size: 0.75rem;
        margin-top: 1.5rem;
    }
    
    .btn-danger:hover {
        background: #dc2626;
    }
    
    .totals-section {
        background: #1f2937;
        color: white;
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin-top: 1.5rem;
    }
    
    .total-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .total-row:last-child {
        border-bottom: 2px solid #10b981;
        font-size: 1.125rem;
        font-weight: 700;
        margin-top: 0.5rem;
        padding-top: 1rem;
    }
    
    .input-icon {
        position: relative;
    }
    
    .input-icon .form-control {
        padding-left: 2.25rem;
    }
    
    .input-icon i {
        position: absolute;
        left: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: #6b7280;
        font-size: 0.875rem;
    }
    
    .page-header {
        background: white;
        border-radius: 0.75rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        border: 1px solid #f3f4f6;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .item-row {
            grid-template-columns: 1fr;
            gap: 0.75rem;
            align-items: start;
        }
        
        .form-section {
            padding: 1rem;
        }
        
        .page-header {
            padding: 1rem;
        }
    }
    
    /* Animation for new items */
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .new-item {
        animation: slideIn 0.3s ease;
    }
    
    /* Status badge styles */
    .status-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .status-draft { background-color: #f3f4f6; color: #1f2937; }
    .status-sent { background-color: #dbeafe; color: #1e40af; }
    .status-paid { background-color: #d1fae5; color: #065f46; }
    .status-overdue { background-color: #fee2e2; color: #991b1b; }
    .status-cancelled { background-color: #e5e7eb; color: #1f2937; }
    
    /* Compact client selection styling */
    .section-header .form-select {
        font-size: 0.8rem;
        padding: 0.375rem 0.75rem;
        min-width: 200px;
        border: 1px solid #d1d5db;
        background-color: white;
    }
    
    .section-header .form-select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }
</style>
{% endblock %}

{% block dashboard_content %}
<div class="p-4 md:p-8">
    <!-- Page Header -->
    <div class="page-header">
        <div class="flex flex-col space-y-4 md:space-y-0 md:flex-row md:justify-between md:items-center">
            <div>
                <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-3">
                    <i class="fas fa-file-invoice text-blue-600"></i>
                    {{ title }}
                </h1>
                <p class="text-sm text-gray-500 mt-1">Create and manage professional invoices</p>
            </div>
            <a href="{% url 'invoice_app:invoice_list' %}" class="btn-secondary">
                <i class="fas fa-arrow-left"></i>
                Back to Invoices
            </a>
        </div>
    </div>

    <form method="post" id="invoice-form" class="space-y-6">
        {% csrf_token %}
        
        <!-- Client Information Section -->
        <div class="form-section">
            <div class="section-header">
                <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-4">
                    <h3 class="section-title">
                        <i class="fas fa-user-tie text-blue-600"></i>
                        Bill To
                    </h3>
                    <!-- Compact Client Selection -->
                    <div class="bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 min-w-0 md:max-w-xs">
                        <label class="text-xs font-medium text-gray-600 block mb-1">Quick Select</label>
                        <div class="relative">
                            {{ form.client }}
                        </div>
                        {{ form.client.errors }}
                    </div>
                </div>
            </div>
            <div class="space-y-6">
                <!-- Row 1: Client Name, Issue Date, Due Date -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="form-group">
                        <label for="{{ form.client_name.id_for_label }}" class="form-label">
                            <i class="fas fa-user text-gray-400 mr-1"></i>Client Name *
                        </label>
                        <input type="text" class="form-control" id="{{ form.client_name.id_for_label }}" name="{{ form.client_name.name }}" value="{{ form.client_name.value|default:'' }}" required>
                        {{ form.client_name.errors }}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.issue_date.id_for_label }}" class="form-label">
                            <i class="fas fa-calendar text-gray-400 mr-1"></i>Issue Date *
                        </label>
                        <input type="date" class="form-control" id="{{ form.issue_date.id_for_label }}" name="{{ form.issue_date.name }}" value="{{ form.issue_date.value|date:'Y-m-d'|default:'' }}" required>
                        {{ form.issue_date.errors }}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.due_date.id_for_label }}" class="form-label">
                            <i class="fas fa-calendar-check text-gray-400 mr-1"></i>Due Date *
                        </label>
                        <input type="date" class="form-control" id="{{ form.due_date.id_for_label }}" name="{{ form.due_date.name }}" value="{{ form.due_date.value|date:'Y-m-d'|default:'' }}" required>
                        {{ form.due_date.errors }}
                    </div>
                </div>

                <!-- Row 2: Email, Phone, Status -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="form-group">
                        <label for="{{ form.client_email.id_for_label }}" class="form-label">
                            <i class="fas fa-envelope text-gray-400 mr-1"></i>Email Address *
                        </label>
                        <input type="email" class="form-control" id="{{ form.client_email.id_for_label }}" name="{{ form.client_email.name }}" value="{{ form.client_email.value|default:'' }}" required>
                        {{ form.client_email.errors }}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.client_phone.id_for_label }}" class="form-label">
                            <i class="fas fa-phone text-gray-400 mr-1"></i>Phone Number
                        </label>
                        <input type="tel" class="form-control" id="{{ form.client_phone.id_for_label }}" name="{{ form.client_phone.name }}" value="{{ form.client_phone.value|default:'' }}">
                        {{ form.client_phone.errors }}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.status.id_for_label }}" class="form-label">
                            <i class="fas fa-flag text-gray-400 mr-1"></i>Status
                        </label>
                        {{ form.status }}
                        {{ form.status.errors }}
                    </div>
                </div>

                <!-- Row 3: Billing Address (Full Width) -->
                <div class="form-group">
                    <label for="{{ form.client_address.id_for_label }}" class="form-label">
                        <i class="fas fa-map-marker-alt text-gray-400 mr-1"></i>Billing Address *
                    </label>
                    <textarea class="form-control" id="{{ form.client_address.id_for_label }}" name="{{ form.client_address.name }}" rows="3" required>{{ form.client_address.value|default:'' }}</textarea>
                    {{ form.client_address.errors }}
                </div>
            </div>
        </div>

        <!-- Invoice Items Section -->
        <div class="form-section">
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fas fa-list text-blue-600"></i>
                    Invoice Items
                </h3>
            </div>
            {{ formset.management_form }}
            <div id="items-container" class="space-y-2">
                {% for item_form in formset %}
                <div class="item-row" id="item-{{ forloop.counter0 }}">
                    {{ item_form.id }}
                    <div class="form-group">
                        <label class="form-label text-xs">
                            <i class="fas fa-tag text-gray-400 mr-1"></i>Description
                        </label>
                        <input type="text" class="item-description" name="{{ item_form.description.name }}" value="{{ item_form.description.value|default:'' }}" placeholder="Item description...">
                        {{ item_form.description.errors }}
                    </div>
                    <div class="form-group">
                        <label class="form-label text-xs">
                            <i class="fas fa-sort-numeric-up text-gray-400 mr-1"></i>Quantity
                        </label>
                        <div class="input-icon">
                            <i class="fas fa-hashtag"></i>
                            <input type="number" class="form-control" name="{{ item_form.quantity.name }}" value="{{ item_form.quantity.value|default:'' }}" step="1" min="1" placeholder="0">
                        </div>
                        {{ item_form.quantity.errors }}
                    </div>
                    <div class="form-group">
                        <label class="form-label text-xs">
                            <i class="text-gray-400 mr-1">₹</i> Unit Price
                        </label>
                        <div class="input-icon">
                            <i class="">₹ </i>
                            <input type="number" class="form-control" name="{{ item_form.unit_price.name }}" value="{{ item_form.unit_price.value|default:'' }}" step="0.5" min="0.5" placeholder="0.0">
                        </div>
                        {{ item_form.unit_price.errors }}
                    </div>
                    <div class="form-group">
                        <label class="form-label text-xs">
                            <i class="fas fa-calculator text-gray-400 mr-1"></i>Total
                        </label>
                        <div class="item-total">
                            ₹<span class="item-total-value">0.00</span>
                        </div>
                    </div>
                    <div class="form-group">
                        {% if item_form.instance.pk %}
                            <div style="display: none;">{{ item_form.DELETE }}</div>
                        {% endif %}
                        <button type="button" class="btn-danger mt-3" onclick="removeItem(this)" title="Remove Item">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <button type="button" id="add-item" class="btn-primary mt-4">
                <i class="fas fa-plus"></i>
                Add New Item
            </button>
        </div>

        <!-- Notes & Terms Section -->
        <div class="form-section">
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fas fa-sticky-note text-blue-600"></i>
                    Additional Information
                </h3>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="form-group">
                    <label for="{{ form.notes.id_for_label }}" class="form-label">
                        <i class="fas fa-comment text-gray-400 mr-1"></i>Notes
                    </label>
                    <textarea class="form-control" id="{{ form.notes.id_for_label }}" name="{{ form.notes.name }}" rows="4" placeholder="Any additional notes or comments...">{{ form.notes.value|default:'' }}</textarea>
                    {{ form.notes.errors }}
                </div>
                <div class="form-group">
                    <label for="{{ form.terms.id_for_label }}" class="form-label">
                        <i class="fas fa-gavel text-gray-400 mr-1"></i>Terms & Conditions
                    </label>
                    <textarea class="form-control" id="{{ form.terms.id_for_label }}" name="{{ form.terms.name }}" rows="4" placeholder="Payment terms and conditions...">{{ form.terms.value|default:'' }}</textarea>
                    {{ form.terms.errors }}
                </div>
            </div>
        </div>

        <!-- Totals Section -->
        <div class="totals-section">
            <h4 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <i class="fas fa-calculator"></i>
                Invoice Summary
            </h4>
            <div class="space-y-2">
                <div class="total-row">
                    <span><i class="fas fa-list-ul mr-2"></i>Subtotal:</span>
                    <span id="subtotal" class="font-semibold">₹0.00</span>
                </div>
                <div class="total-row">
                    <span><i class="fas fa-percentage mr-2"></i>Tax (18%):</span>
                    <span id="tax" class="font-semibold">₹0.00</span>
                </div>
                <div class="total-row">
                    <span><i class="fas fa-money-bill-wave mr-2"></i>Grand Total:</span>
                    <span id="total" class="font-bold">₹0.00</span>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="form-section">
            <div class="flex justify-end space-x-4">
                <a href="{% url 'invoice_app:invoice_list' %}" class="btn-secondary">
                    <i class="fas fa-times"></i>
                    Cancel
                </a>
                <button type="submit" class="btn-primary" id="submit-btn">
                    <i class="fas fa-save"></i>
                    {{ submit_btn }}
                </button>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- SweetAlert2 for beautiful alerts -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Custom External JavaScript -->
<script>
    let formsetIndex = 0;

    $(document).ready(function() {
        // Initialize form
        initializeForm();
        
        // Update all existing item totals
        updateAllItemTotals();
        
        // Calculate totals when page loads
        calculateTotals();
        
        // Event listeners
        setupEventListeners();
    });

    function initializeForm() {
        // Set formset index to current number of forms
        formsetIndex = parseInt($('#id_items-TOTAL_FORMS').val()) || 0;
    }

    function updateAllItemTotals() {
        // Update totals for all existing item rows
        $('.item-row').each(function() {
            updateItemTotal($(this));
        });
    }

    function setupEventListeners() {
        // Calculate totals on input change - simpler and more reliable
        $(document).on('input change blur keyup', 'input[name*="quantity"], input[name*="unit_price"]', function() {
            const $input = $(this);
            const name = $input.attr('name');
            
            console.log('Input detected:', name, '=', $input.val());
            updateItemTotal($input.closest('.item-row'));
            calculateTotals();
        });

        // Add new item
        $('#add-item').click(function(e) {
            e.preventDefault();
            addNewItem();
        });
    }

    function addNewItem() {
        const newItemHtml = `
            <div class="item-row new-item" id="item-${formsetIndex}">
                <input type="hidden" name="items-${formsetIndex}-id" id="id_items-${formsetIndex}-id">
                <div class="form-group">
                    <label class="form-label text-xs">
                        <i class="fas fa-tag text-gray-400 mr-1"></i>Description
                    </label>
                    <input type="text" class="item-description" name="items-${formsetIndex}-description" placeholder="Item description...">
                </div>
                <div class="form-group">
                    <label class="form-label text-xs">
                        <i class="fas fa-sort-numeric-up text-gray-400 mr-1"></i>Quantity
                    </label>
                    <div class="input-icon">
                        <i class="fas fa-hashtag"></i>
                        <input type="number" class="form-control" name="items-${formsetIndex}-quantity" step="1" min="1" placeholder="0">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label text-xs">
                        <i class="text-gray-400 mr-1">₹</i> Unit Price
                    </label>
                    <div class="input-icon">
                        <i class="">₹ </i>
                        <input type="number" class="form-control" name="items-${formsetIndex}-unit_price" step="0.5" min="0.5" placeholder="0.0">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label text-xs">
                        <i class="fas fa-calculator text-gray-400 mr-1"></i>Total
                    </label>
                    <div class="item-total">
                        ₹<span class="item-total-value">0.00</span>
                    </div>
                </div>
                <div class="form-group">
                    <button type="button" class="btn-danger mt-3" onclick="removeItem(this)" title="Remove Item">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        
        $('#items-container').append(newItemHtml);
        
        // Update management form
        formsetIndex++;
        $('#id_items-TOTAL_FORMS').val(formsetIndex);
        
        // Show success notification
        showToast('Item added successfully!', 'success');
    }

    function removeItem(button) {
        const $row = $(button).closest('.item-row');
        const deleteInput = $row.find('input[name$="-DELETE"]');
        
        if (deleteInput.length) {
            // Mark for deletion if it's an existing item
            deleteInput.prop('checked', true);
            $row.hide();
        } else {
            // Remove if it's a new item
            $row.remove();
            // Update form count
            const currentTotal = parseInt($('#id_items-TOTAL_FORMS').val()) - 1;
            $('#id_items-TOTAL_FORMS').val(currentTotal);
            
            // Reindex remaining forms
            $('.item-row').each(function(index) {
                const $form = $(this);
                if (!$form.find('input[name$="-DELETE"]').length) {
                    // Update form field names for dynamically added items
                    $form.find('input, select, textarea').each(function() {
                        const $field = $(this);
                        const name = $field.attr('name');
                        if (name && name.startsWith('items-') && !name.endsWith('-id')) {
                            const newName = name.replace(/items-\d+-/, `items-${index}-`);
                            $field.attr('name', newName);
                            if ($field.attr('id')) {
                                $field.attr('id', $field.attr('id').replace(/items-\d+-/, `items-${index}-`));
                            }
                        }
                    });
                }
            });
            
            // Update formsetIndex
            formsetIndex = $('.item-row').length;
        }
        
        calculateTotals();
        showToast('Item removed successfully!', 'info');
    }

    function updateItemTotal($row) {
        // More robust selectors - look for inputs that contain quantity or unit_price in their names
        const quantityInput = $row.find('input[name*="quantity"]');
        const priceInput = $row.find('input[name*="unit_price"]');
        const totalSpan = $row.find('.item-total-value');
        
        if (quantityInput.length && priceInput.length && totalSpan.length) {
            const quantity = parseFloat(quantityInput.val()) || 0;
            const price = parseFloat(priceInput.val()) || 0;
            const total = (quantity * price).toFixed(2);
            
            console.log('Updating row total:', quantity, 'x', price, '=', total);
            totalSpan.text(total);
        } else {
            console.log('Missing elements in row:', {
                quantity: quantityInput.length,
                price: priceInput.length,
                total: totalSpan.length,
                quantityName: quantityInput.attr('name'),
                priceName: priceInput.attr('name')
            });
        }
    }

    function calculateTotals() {
        let subtotal = 0;
        const $subtotalEl = $('#subtotal');
        const $taxEl = $('#tax');
        const $totalEl = $('#total');
        
        console.log('Starting total calculation...');
        
        $('.item-row:visible').each(function() {
            const $row = $(this);
            // Skip items marked for deletion
            if (!$row.find('input[name$="-DELETE"]').is(':checked')) {
                const quantityInput = $row.find('input[name*="quantity"]');
                const priceInput = $row.find('input[name*="unit_price"]');
                
                const quantity = parseFloat(quantityInput.val()) || 0;
                const price = parseFloat(priceInput.val()) || 0;
                const itemTotal = quantity * price;
                
                subtotal += itemTotal;
                console.log('Row calculation:', quantity, 'x', price, '=', itemTotal, '| Running subtotal:', subtotal);
            }
        });
        
        const tax = subtotal * 0.18; // 18% tax
        const total = subtotal + tax;
        
        console.log('Final totals - Subtotal:', subtotal, 'Tax:', tax, 'Total:', total);
        
        // Update display elements
        if ($subtotalEl.length) $subtotalEl.text('₹' + subtotal.toFixed(2));
        if ($taxEl.length) $taxEl.text('₹' + tax.toFixed(2));
        if ($totalEl.length) $totalEl.text('₹' + total.toFixed(2));
        
        console.log('Display updated');
    }

    // Client auto-population functionality
    function populateClientFields(clientData) {
        console.log('Populating client fields with:', clientData);
        
        // Populate the form fields
        const clientNameInput = $('#{{ form.client_name.id_for_label }}');
        const clientEmailInput = $('#{{ form.client_email.id_for_label }}');
        const clientPhoneInput = $('#{{ form.client_phone.id_for_label }}');
        const clientAddressInput = $('#{{ form.client_address.id_for_label }}');
        
        if (clientData) {
            clientNameInput.val(clientData.name);
            clientEmailInput.val(clientData.email);
            clientPhoneInput.val(clientData.phone || '');
            
            // Construct full address
            let fullAddress = clientData.address;
            if (clientData.city) fullAddress += '\n' + clientData.city;
            if (clientData.state) fullAddress += ', ' + clientData.state;
            if (clientData.postal_code) fullAddress += ' ' + clientData.postal_code;
            if (clientData.country && clientData.country !== 'India') fullAddress += '\n' + clientData.country;
            
            clientAddressInput.val(fullAddress);
            
            showToast('Client information loaded successfully!', 'success');
        } else {
            // Clear the fields if no client selected
            clientNameInput.val('');
            clientEmailInput.val('');
            clientPhoneInput.val('');
            clientAddressInput.val('');
        }
    }
    
    // Handle client selection change
    $('#{{ form.client.id_for_label }}').on('change', function() {
        const selectedClientId = $(this).val();
        console.log('Client selection changed to:', selectedClientId);
        
        if (selectedClientId) {
            // Fetch client data via AJAX
            $.ajax({
                url: '{% url "invoice_app:api_client_data" 0 %}'.replace('0', selectedClientId),
                method: 'GET',
                success: function(data) {
                    populateClientFields(data);
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching client data:', error);
                    showToast('Error loading client information', 'error');
                }
            });
        } else {
            populateClientFields(null);
        }
    });

    function showToast(message, type = 'info') {
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
        });
        
        Toast.fire({
            icon: type,
            title: message
        });
    }

    // Form submission handler
    $('#invoice-form').on('submit', function(e) {
        console.log('Form submission triggered');
        
        // Check if this is an update operation (invoice already exists)
        const isUpdate = $('#invoice-form').data('is-update') || '{{ invoice.pk }}' !== '';
        
        // Check if we have at least one item with data (including visible forms)
        let hasValidItems = false;
        $('.item-row:visible').each(function() {
            const $row = $(this);
            if (!$row.find('input[name$="-DELETE"]').is(':checked')) {
                const description = $row.find('input[name*="-description"]').val();
                const quantity = $row.find('input[name*="-quantity"]').val();
                const price = $row.find('input[name*="-unit_price"]').val();
                
                if (description && quantity && price) {
                    hasValidItems = true;
                    console.log('Found valid item:', description, quantity, price);
                }
            }
        });
        
        // For updates, if no visible items found, check if this is just a status/field update
        if (!hasValidItems && isUpdate) {
            // For update operations, allow submission if form is valid
            // Backend will handle the validation of existing items
            console.log('Update operation detected - allowing backend validation');
            hasValidItems = true;
        }
        
        if (!hasValidItems) {
            e.preventDefault();
            showToast('Please add at least one item with description, quantity, and price', 'error');
            return false;
        }
        
        console.log('Form validation passed, submitting...');
        const $submitBtn = $('#submit-btn');
        $submitBtn.html('<i class="fas fa-spinner fa-spin mr-2"></i>Saving...');
        $submitBtn.prop('disabled', true);
    });
</script>
{% endblock %}