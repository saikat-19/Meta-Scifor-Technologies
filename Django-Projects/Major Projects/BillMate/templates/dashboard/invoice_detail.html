{% extends 'dashboard/base_dashboard.html' %}
{% load static %}
{% load humanize %}

{% block extra_head %}
<!-- Tailwind CSS CDN -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Font Awesome Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    /* Hide print layout on screen */
    .print-invoice {
        display: none;
    }
    
    /* Screen-only dashboard styles */
    .dashboard-view {
        display: block;
    }
    
    @media print {
        /* Show only print layout */
        .print-invoice {
            display: block !important;
            max-width: 8.5in !important;
            margin: 0 auto !important;
            padding: 0.5in !important;
            background: white !important;
            position: relative !important;
            z-index: 9999 !important;
        }
        
        /* Hide dashboard content */
        .dashboard-view {
            display: none !important;
        }
        
        /* Reset everything for clean print */
        * {
            box-shadow: none !important;
            border-radius: 0 !important;
            background-image: none !important;
        }
        
        /* Reset body and layout */
        html, body {
            background: white !important;
            font-family: Arial, sans-serif !important;
            font-size: 12px !important;
            line-height: 1.4 !important;
            color: #000 !important;
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important;
            height: auto !important;
        }
        
        /* Invoice header */
        .print-header {
            display: flex !important;
            justify-content: space-between !important;
            align-items: flex-start !important;
            margin-bottom: 30px !important;
            border-bottom: 2px solid #333 !important;
            padding-bottom: 20px !important;
        }
        
        .print-logo-section h1 {
            font-size: 24px !important;
            font-weight: bold !important;
            color: #333 !important;
            margin: 0 0 10px 0 !important;
        }
        
        .print-company-info {
            font-size: 11px !important;
            color: #666 !important;
            line-height: 1.3 !important;
        }
        
        .print-invoice-title {
            text-align: right !important;
        }
        
        .print-invoice-title h2 {
            font-size: 28px !important;
            font-weight: bold !important;
            color: #333 !important;
            margin: 0 !important;
        }
        
        /* Invoice details section */
        .print-details {
            display: flex !important;
            justify-content: space-between !important;
            margin-bottom: 30px !important;
        }
        
        .print-bill-to, .print-invoice-info {
            width: 48% !important;
        }
        
        .print-section-title {
            font-size: 12px !important;
            font-weight: bold !important;
            color: #333 !important;
            margin-bottom: 10px !important;
            text-transform: uppercase !important;
            letter-spacing: 1px !important;
        }
        
        .print-client-name {
            font-size: 14px !important;
            font-weight: bold !important;
            color: #000 !important;
            margin-bottom: 5px !important;
        }
        
        .print-client-details {
            font-size: 11px !important;
            color: #666 !important;
            line-height: 1.4 !important;
        }
        
        .print-invoice-meta {
            border: 1px solid #ddd !important;
            padding: 15px !important;
        }
        
        .print-meta-row {
            display: flex !important;
            justify-content: space-between !important;
            margin-bottom: 8px !important;
            font-size: 11px !important;
        }
        
        .print-meta-label {
            font-weight: bold !important;
            color: #333 !important;
        }
        
        .print-meta-value {
            color: #000 !important;
        }
        
        /* Items table */
        .print-table {
            width: 100% !important;
            border-collapse: collapse !important;
            margin-bottom: 30px !important;
        }
        
        .print-table th {
            background-color: #f5f5f5 !important;
            border: 1px solid #ddd !important;
            padding: 12px 8px !important;
            font-size: 11px !important;
            font-weight: bold !important;
            text-transform: uppercase !important;
            text-align: left !important;
        }
        
        .print-table td {
            border: 1px solid #ddd !important;
            padding: 10px 8px !important;
            font-size: 11px !important;
        }
        
        .print-table .text-right {
            text-align: right !important;
        }
        
        .print-table .text-center {
            text-align: center !important;
        }
        
        /* Totals section */
        .print-totals {
            width: 300px !important;
            margin-left: auto !important;
            margin-bottom: 30px !important;
        }
        
        .print-total-row {
            display: flex !important;
            justify-content: space-between !important;
            padding: 8px 0 !important;
            border-bottom: 1px solid #eee !important;
            font-size: 11px !important;
        }
        
        .print-total-row.final {
            border-bottom: 2px solid #333 !important;
            border-top: 2px solid #333 !important;
            font-size: 14px !important;
            font-weight: bold !important;
            margin-top: 10px !important;
            padding-top: 10px !important;
        }
        
        /* Footer */
        .print-footer {
            text-align: center !important;
            margin-top: 40px !important;
            padding-top: 20px !important;
            border-top: 1px solid #ddd !important;
        }
        
        .print-thank-you {
            font-size: 18px !important;
            font-weight: bold !important;
            color: #333 !important;
            margin-bottom: 15px !important;
        }
        
        .print-footer-text {
            font-size: 10px !important;
            color: #666 !important;
            line-height: 1.4 !important;
        }
        
        /* Page break settings */
        .print-invoice {
            page-break-inside: avoid !important;
        }
        
        .print-table {
            page-break-inside: auto !important;
        }
        
        .print-table tr {
            page-break-inside: avoid !important;
            page-break-after: auto !important;
        }
    }
    
    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .status-draft { background-color: #f3f4f6; color: #1f2937; }
    .status-sent { background-color: #dbeafe; color: #1e40af; }
    .status-paid { background-color: #d1fae5; color: #065f46; }
    .status-overdue { background-color: #fee2e2; color: #991b1b; }
    .status-cancelled { background-color: #e5e7eb; color: #1f2937; }
    
    .info-card {
        background: #f9fafb;
        border: 1px solid #f3f4f6;
        border-radius: 0.5rem;
        padding: 1.5rem;
    }
    
    .totals-section {
        background: #1f2937;
        color: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
    }
    
    .total-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .total-row:last-child {
        border-bottom: 2px solid #10b981;
        font-size: 1.125rem;
        font-weight: 700;
        margin-top: 0.5rem;
        padding-top: 1rem;
    }
</style>
{% endblock %}

{% block dashboard_content %}
<!-- Print-only invoice layout -->
<div class="print-invoice">
    <!-- Invoice Header -->
    <div class="print-header">
        <div class="print-logo-section">
            <h1>{{ profile.company_name }}</h1>
            <div class="print-company-info">
                {{ profile.address }}<br>
                {{ profile.city }}, {{ profile.state }} {{ profile.postal_code }}<br>
                {{ profile.country }}<br>
                Phone: {{ profile.phone }}<br>
                Email: {{ profile.email }}
            </div>
        </div>
        <div class="print-invoice-title">
            <h2>INVOICE</h2>
        </div>
    </div>
    
    <!-- Invoice Details -->
    <div class="print-details">
        <div class="print-bill-to">
            <div class="print-section-title">Bill To:</div>
            <div class="print-client-name">{{ invoice.client_name }}</div>
            <div class="print-client-details">
                {{ invoice.client_email }}<br>
                {% if invoice.client_phone %}
                    {{ invoice.client_phone }}<br>
                {% endif %}
                {{ invoice.client_address|linebreaksbr }}
            </div>
        </div>
        
        <div class="print-invoice-info">
            <div class="print-invoice-meta">
                <div class="print-meta-row">
                    <span class="print-meta-label">Date of Invoice:</span>
                    <span class="print-meta-value">{{ invoice.issue_date|date:"M d, Y" }}</span>
                </div>
                <div class="print-meta-row">
                    <span class="print-meta-label">Invoice No:</span>
                    <span class="print-meta-value">{{ invoice.invoice_number }}</span>
                </div>
                <div class="print-meta-row">
                    <span class="print-meta-label">Date Due:</span>
                    <span class="print-meta-value">{{ invoice.due_date|date:"M d, Y" }}</span>
                </div>
                <div class="print-meta-row">
                    <span class="print-meta-label">Amount:</span>
                    <span class="print-meta-value">₹{{ invoice.total|floatformat:2|intcomma }}</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Items Table -->
    <table class="print-table">
        <thead>
            <tr>
                <th style="width: 50%;">Description</th>
                <th style="width: 15%;" class="text-center">Quantity</th>
                <th style="width: 15%;" class="text-right">Unit Price</th>
                <th style="width: 20%;" class="text-right">Amount</th>
            </tr>
        </thead>
        <tbody>
            {% for item in invoice.items.all %}
            <tr>
                <td>{{ item.description }}</td>
                <td class="text-center">{{ item.quantity }}</td>
                <td class="text-right">₹{{ item.unit_price|floatformat:2|intcomma }}</td>
                <td class="text-right">₹{{ item.total|floatformat:2|intcomma }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="4" style="text-align: center; padding: 20px; color: #666;">No items found</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <!-- Totals -->
    <div class="print-totals">
        <div class="print-total-row">
            <span>Subtotal:</span>
            <span>₹{{ invoice.subtotal|floatformat:2|intcomma }}</span>
        </div>
        <div class="print-total-row">
            <span>Tax (18%):</span>
            <span>₹{{ invoice.tax_amount|floatformat:2|intcomma }}</span>
        </div>
        <div class="print-total-row final">
            <span>TOTAL:</span>
            <span>₹{{ invoice.total|floatformat:2|intcomma }}</span>
        </div>
    </div>
    
    <!-- Footer -->
    <div class="print-footer">
        <div class="print-thank-you">THANK YOU</div>
        <div class="print-footer-text">
            Please make check payable to {{ profile.company_name }}.<br>
            For questions concerning this invoice, please contact<br>
            {{ profile.phone }}, {{ profile.email }}<br><br>
            {% if profile.website %}{{ profile.website }}{% else %}{{ profile.company_name }}{% endif %}
        </div>
    </div>
</div>

<div class="dashboard-view">
<div class="p-4 md:p-8">
    <!-- Page Header -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex flex-col space-y-4 lg:flex-row lg:items-center lg:justify-between lg:space-y-0">
                <div class="flex items-center space-x-4">
                    <div class="p-2 bg-blue-100 rounded-lg">
                        <i class="fas fa-file-invoice text-blue-600 text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">{{ invoice.invoice_number }}</h1>
                        <div class="flex items-center space-x-4 mt-1">
                            <span class="status-badge status-{{ invoice.status }}">{{ invoice.get_status_display }}</span>
                            <span class="text-sm text-gray-500">
                                <i class="fas fa-calendar mr-1"></i>
                                Issued: {{ invoice.issue_date|date:"M d, Y" }}
                            </span>
                            <span class="text-sm text-gray-500">
                                <i class="fas fa-calendar-check mr-1"></i>
                                Due: {{ invoice.due_date|date:"M d, Y" }}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="flex flex-wrap gap-2 no-print">
                    <a href="{% url 'invoice_app:invoice_update' invoice.pk %}" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-200">
                        <i class="fas fa-edit mr-2"></i>
                        Edit
                    </a>
                    <button onclick="window.print()" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-200">
                        <i class="fas fa-print mr-2"></i>
                        Print
                    </button>
                    <form action="{% url 'invoice_app:invoice_delete' invoice.pk %}" method="post" class="inline" id="delete-form">
                        {% csrf_token %}
                        <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent rounded-lg text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-200"
                                onclick="return confirm('Are you sure you want to delete this invoice? This action cannot be undone.')">
                            <i class="fas fa-trash mr-2"></i>
                            Delete
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Content -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
        <!-- Company Header -->
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6">
            <div class="flex flex-col lg:flex-row lg:justify-between lg:items-start space-y-4 lg:space-y-0">
                <div>
                    <h2 class="text-3xl font-bold mb-2">{{ profile.company_name }}</h2>
                    <div class="text-blue-100">
                        <p>{{ profile.address }}</p>
                        <p>{{ profile.city }}, {{ profile.state }} {{ profile.postal_code }}</p>
                        <p>{{ profile.country }}</p>
                    </div>
                </div>
                <div class="text-right">
                    <div class="bg-white bg-opacity-20 rounded-lg p-4">
                        <h3 class="text-lg font-semibold mb-2">Invoice Total</h3>
                        <div class="text-3xl font-bold">₹{{ invoice.total|floatformat:2|intcomma }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Invoice Details -->
        <div class="p-6">
            <!-- Client and Invoice Info -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="info-card">
                    <h4 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
                        <i class="fas fa-user-tie text-blue-600 mr-2"></i>
                        Bill To
                    </h4>
                    <div class="space-y-2">
                        <p class="font-semibold text-gray-900">{{ invoice.client_name }}</p>
                        <p class="text-gray-600">
                            <i class="fas fa-envelope text-gray-400 mr-2"></i>
                            {{ invoice.client_email }}
                        </p>
                        {% if invoice.client_phone %}
                        <p class="text-gray-600">
                            <i class="fas fa-phone text-gray-400 mr-2"></i>
                            {{ invoice.client_phone }}
                        </p>
                        {% endif %}
                        <p class="text-gray-600">
                            <i class="fas fa-map-marker-alt text-gray-400 mr-2"></i>
                            <span class="whitespace-pre-line">{{ invoice.client_address }}</span>
                        </p>
                    </div>
                </div>
                
                <div class="info-card">
                    <h4 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
                        <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                        Invoice Details
                    </h4>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Invoice Number:</span>
                            <span class="font-semibold text-gray-900">{{ invoice.invoice_number }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Issue Date:</span>
                            <span class="font-semibold text-gray-900">{{ invoice.issue_date|date:"M d, Y" }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Due Date:</span>
                            <span class="font-semibold text-gray-900">{{ invoice.due_date|date:"M d, Y" }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Status:</span>
                            <span class="status-badge status-{{ invoice.status }}">{{ invoice.get_status_display }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Invoice Items -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-list text-blue-600 mr-2"></i>
                    Invoice Items
                </h4>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Unit Price</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for item in invoice.items.all %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ item.description }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 text-center">{{ item.quantity }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 text-right">₹{{ item.unit_price|floatformat:2|intcomma }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900 text-right">₹{{ item.total|floatformat:2|intcomma }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="px-6 py-12 text-center text-gray-500">
                                    <i class="fas fa-inbox text-4xl text-gray-300 mb-2 block"></i>
                                    <p>No items found</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Invoice Totals -->
            <div class="flex justify-end mb-8">
                <div class="w-full max-w-md">
                    <div class="totals-section">
                        <h4 class="text-lg font-semibold mb-4 flex items-center">
                            <i class="fas fa-calculator mr-2"></i>
                            Invoice Summary
                        </h4>
                        <div class="space-y-2">
                            <div class="total-row">
                                <span><i class="fas fa-list-ul mr-2"></i>Subtotal:</span>
                                <span class="font-semibold">₹{{ invoice.subtotal|floatformat:2|intcomma }}</span>
                            </div>
                            <div class="total-row">
                                <span><i class="fas fa-percentage mr-2"></i>Tax (18%):</span>
                                <span class="font-semibold">₹{{ invoice.tax_amount|floatformat:2|intcomma }}</span>
                            </div>
                            <div class="total-row">
                                <span><i class="fas fa-money-bill-wave mr-2"></i>Grand Total:</span>
                                <span class="font-bold text-xl">₹{{ invoice.total|floatformat:2|intcomma }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notes and Terms -->
            {% if invoice.notes or invoice.terms %}
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {% if invoice.notes %}
                <div class="info-card">
                    <h4 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
                        <i class="fas fa-comment text-blue-600 mr-2"></i>
                        Notes
                    </h4>
                    <p class="text-gray-700 whitespace-pre-line">{{ invoice.notes }}</p>
                </div>
                {% endif %}
                
                {% if invoice.terms %}
                <div class="info-card">
                    <h4 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
                        <i class="fas fa-gavel text-blue-600 mr-2"></i>
                        Terms & Conditions
                    </h4>
                    <p class="text-gray-700 whitespace-pre-line">{{ invoice.terms }}</p>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Bottom Actions -->
    <div class="mt-6 flex flex-col sm:flex-row sm:justify-between sm:items-center space-y-4 sm:space-y-0 no-print">
        {% if not is_public %}
            <a href="{% url 'invoice_app:invoice_list' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-200">
                <i class="fas fa-arrow-left mr-2"></i> Back to Invoices
            </a>
            <div class="flex space-x-3">
                <a href="{% url 'invoice_app:invoice_update' invoice.id %}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-200">
                    <i class="fas fa-edit mr-2"></i> Edit Invoice
                </a>
                <button onclick="window.print()" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-200">
                    <i class="fas fa-print mr-2"></i> Print
                </button>
                <form method="post" action="{% url 'invoice_app:send_invoice_email' invoice.id %}" class="inline">
                    {% csrf_token %}
                    <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-200">
                        <i class="fas fa-paper-plane mr-2"></i> Send to Client
                    </button>
                </form>
            </div>
        {% else %}
            <div class="w-full text-center py-4">
                <button onclick="window.print()" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-200">
                    <i class="fas fa-print mr-2"></i> Print Invoice
                </button>
            </div>
        {% endif %}
    </div>
</div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
    });
</script>
{% endblock %}