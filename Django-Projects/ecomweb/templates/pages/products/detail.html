{% extends 'base/base.html' %}
{% load static %}

{% block title %}{{ product.name }} - ShopEase{% endblock %}

{% block extra_js %}
    <script src="{% static 'js/product-detail.js' %}"></script>
    <script>
        // Apply colors to variant swatches
        document.addEventListener('DOMContentLoaded', function() {
            const swatches = document.querySelectorAll('.color-swatch');
            swatches.forEach(swatch => {
                const color = swatch.getAttribute('data-color');
                if (color) {
                    swatch.style.backgroundColor = color;
                }
            });
        });
    </script>
{% endblock %}

{% block content %}
<div class="bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Left Card - Product Images -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <!-- Main image -->
                <div class="w-full aspect-w-1 aspect-h-1 overflow-hidden">
                    {% with product.images.first as main_image %}
                        {% if main_image %}
                            <img src="{{ main_image.image.url }}" 
                                 alt="{{ main_image.alt_text|default:product.name }}" 
                                 class="w-full h-full object-cover object-center p-4"
                                 id="main-product-image">
                        {% else %}
                            <img src="{% static 'images/placeholder-product.png' %}" 
                                 alt="{{ product.name }}"
                                 class="w-full h-full object-cover object-center p-4"
                                 id="main-product-image">
                        {% endif %}
                    {% endwith %}
                </div>
                
                <!-- Thumbnails -->
                {% if product.images.count > 1 %}
                <div class="p-4 border-t border-gray-100">
                    <div class="grid grid-cols-4 gap-3">
                        {% for image in product.images.all %}
                        <button type="button" 
                                class="w-full h-20 rounded-md overflow-hidden transition-all duration-200 hover:ring-2 hover:ring-offset-2 hover:ring-indigo-500 {% if forloop.first %}ring-2 ring-offset-2 ring-indigo-500{% endif %}"
                                onclick="document.getElementById('main-product-image').src='{{ image.image.url }}'; this.parentElement.parentElement.querySelectorAll('button').forEach(btn => btn.classList.remove('ring-2', 'ring-offset-2', 'ring-indigo-500')); this.classList.add('ring-2', 'ring-offset-2', 'ring-indigo-500');">
                            <img src="{{ image.image.url }}" 
                                 alt="{{ image.alt_text|default:product.name }}" 
                                 class="w-full h-full object-cover object-center">
                        </button>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Right Card - Product Info -->
            <div class="bg-white rounded-lg shadow-md p-8">
                <div class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-900 leading-tight mb-2">{{ product.name }}</h1>
                    
                    <!-- Price -->
                    <div class="mt-4 mb-6">
                        <p class="text-3xl font-semibold text-indigo-700">₹{{ product.price }}</p>
                        {% if product.compare_at_price %}
                        <p class="text-lg text-gray-500 line-through mt-1">₹{{ product.compare_at_price }}</p>
                        {% endif %}
                    </div>

                    <!-- Reviews -->
                    {% if product.rating %}
                    <div class="flex items-center mb-6">
                        <div class="flex items-center bg-indigo-50 px-3 py-1 rounded-full">
                            {% for i in "12345"|make_list %}
                                {% if forloop.counter <= product.rating %}
                                    <i class="fas fa-star text-yellow-500 text-sm"></i>
                                {% else %}
                                    <i class="far fa-star text-yellow-500 text-sm"></i>
                                {% endif %}
                            {% endfor %}
                            <span class="ml-2 text-sm font-medium text-indigo-800">{{ product.rating|floatformat:1 }}</span>
                        </div>
                        <span class="ml-3 text-sm text-gray-600">{{ product.review_count }} reviews</span>
                        {% if product.in_stock %}
                        <span class="ml-4 flex items-center text-sm text-green-600">
                            <i class="fas fa-check-circle mr-1"></i> In Stock
                        </span>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>

                <!-- Description -->
                <div class="mb-8 pb-6 border-b border-gray-100">
                    <h3 class="text-lg font-semibold text-gray-900 mb-3">Description</h3>
                    <div class="prose max-w-none text-gray-600 leading-relaxed">
                        {{ product.description|linebreaks }}
                    </div>
                </div>

                <form method="post" action="{% url 'ecom:cart_add' product_id=product.id %}" id="add-to-cart-form">
                    {% csrf_token %}
                    
                    <!-- Variants -->
                    {% if product.variants.exists %}
                    <div class="mb-8">
                        <h3 class="text-base font-semibold text-gray-900 mb-3 flex items-center">
                            <i class="fas fa-palette text-indigo-600 mr-2 text-sm"></i>
                            Color
                        </h3>
                        <div class="flex flex-wrap gap-3">
                            {% for variant in product.variants.all %}
                            <label class="relative group">
                                <input type="radio" 
                                       name="variant_id" 
                                       value="{{ variant.id }}" 
                                       class="sr-only peer" 
                                       {% if forloop.first %}checked{% endif %}>
                                <span class="color-swatch flex items-center justify-center h-12 w-12 rounded-full border-2 border-transparent peer-checked:border-indigo-500 overflow-hidden transition-all duration-200 transform group-hover:scale-105"
                                      data-color="{{ variant.color_code|default:'#000000' }}"
                                      title="{{ variant.name }}">
                                    <span class="sr-only">{{ variant.name }}</span>
                                </span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Size - Only show if sizes exist -->
                    {% if product.get_available_sizes %}
                    <div class="mb-8">
                        <h3 class="text-base font-semibold text-gray-900 mb-3 flex items-center">
                            <i class="fas fa-ruler-horizontal text-indigo-600 mr-2 text-sm"></i>
                            Size
                            <a href="#size-guide" class="ml-2 text-xs font-normal text-indigo-600 hover:text-indigo-800 hover:underline">(Size Guide)</a>
                        </h3>
                        <div class="grid grid-cols-6 gap-3">
                            {% for size in product.get_available_sizes %}
                            <label class="relative">
                                <input type="radio" 
                                       name="size" 
                                       value="{{ size }}" 
                                       class="sr-only peer" 
                                       {% if forloop.first %}checked{% endif %}>
                                <span class="flex items-center justify-center h-12 w-12 rounded border-2 border-gray-200 peer-checked:border-indigo-500 peer-checked:bg-indigo-50 text-sm font-medium text-gray-800 hover:bg-gray-50 transition-all duration-200">
                                    {{ size }}
                                </span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Quantity -->
                    <div class="mb-8">
                        <label class="block text-base font-semibold text-gray-900 mb-3 flex items-center">
                            <i class="fas fa-boxes text-indigo-600 mr-2 text-sm"></i>
                            Quantity
                        </label>
                        <div class="flex items-center w-48 space-x-0.5">
                            <button type="button" 
                                    class="decrement-btn bg-gray-50 text-gray-700 border border-gray-300 rounded-l-lg h-12 w-12 flex items-center justify-center hover:bg-gray-100 focus:outline-none focus:ring-1 focus:ring-indigo-500 transition-all duration-200">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="number" 
                                   id="quantity" 
                                   name="quantity" 
                                   value="1" 
                                   min="1" 
                                   max="{{ product.stock|default:10 }}" 
                                   class="h-12 w-full text-center border-t border-b border-gray-300 focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-lg font-medium"
                                   aria-label="Quantity">
                            <button type="button" 
                                    class="increment-btn bg-gray-50 text-gray-700 border border-gray-300 rounded-r-lg h-12 w-12 flex items-center justify-center hover:bg-gray-100 focus:outline-none focus:ring-1 focus:ring-indigo-500 transition-all duration-200">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        {% if product.stock <= 5 and product.stock > 0 %}
                        <p class="mt-2 text-sm text-amber-600">Only {{ product.stock }} left in stock!</p>
                        {% endif %}
                    </div>

                    <!-- Actions -->
                    <div class="pt-2">
                        <button type="submit" 
                                class="w-full bg-indigo-600 border border-transparent rounded-lg py-4 px-8 flex items-center justify-center text-base font-semibold text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200 transform hover:scale-[1.02] shadow-md hover:shadow-lg">
                            <i class="fas fa-shopping-cart mr-3"></i> Add to Cart
                        </button>
                        <p class="mt-3 text-center text-sm text-gray-500">
                            <i class="fas fa-shield-alt text-gray-400 mr-1"></i> Secure checkout
                        </p>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Related products -->
<section aria-labelledby="related-heading" class="bg-white">
    <div class="max-w-7xl mx-auto py-24 px-4 sm:py-32 sm:px-6 lg:px-8">
        <h2 id="related-heading" class="text-2xl font-extrabold text-gray-900">You may also like</h2>

        <div class="mt-8 grid grid-cols-1 gap-y-12 sm:grid-cols-2 sm:gap-x-6 lg:grid-cols-4 xl:gap-x-8">
            {% for related in related_products %}
            <div class="relative">
                <div class="relative w-full h-72 rounded-lg overflow-hidden">
                    <img src="{{ related.primary_image.url|default:'https://tailwindui.com/img/ecommerce-images/product-page-01-related-product-01.jpg' }}" alt="{{ related.name }}" class="w-full h-full object-center object-cover">
                </div>
                <div class="relative mt-4">
                    <h3 class="text-sm font-medium text-gray-900">
                        <a href="{% url 'ecom:product_detail' related.slug %}">
                            <span aria-hidden="true" class="absolute inset-0"></span>
                            {{ related.name }}
                        </a>
                    </h3>
                    <p class="mt-1 text-sm text-gray-500">{{ related.category.name }}</p>
                </div>
                <div class="absolute top-0 inset-x-0 h-72 rounded-lg p-4 flex items-end justify-end overflow-hidden">
                    <div aria-hidden="true" class="absolute inset-x-0 bottom-0 h-36 bg-gradient-to-t from-black opacity-50"></div>
                    <p class="relative text-lg font-semibold text-white">${{ related.price }}</p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>

        <!-- End of main content -->
        
    </div>
</div>

<!-- Related products -->
{% endblock %}